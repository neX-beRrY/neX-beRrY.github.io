<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人笔记系统</title>
    <!-- Markdown 解析器 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX 数学公式支持 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --sidebar-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4a90e2;
            --border-color: #404040;
            --hover-color: #3a3a3a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* 分类树样式 */
        .category-tree {
            list-style: none;
        }
        
        .category-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .category-item:hover {
            background-color: var(--hover-color);
        }
        
        .category-item.active {
            background-color: var(--accent-color);
        }
        
        .category-item .icon {
            margin-right: 8px;
            font-size: 14px;
        }
        
        .category-children {
            margin-left: 20px;
            display: none;
        }
        
        .category-item.expanded > .category-children {
            display: block;
        }
        
        /* 主内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-title {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: bold;
            width: 100%;
            padding: 5px 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .editor-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
        }
        
        .preview-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        textarea {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            resize: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .preview {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 4px;
            height: 100%;
            overflow-y: auto;
        }
        
        /* 按钮样式 */
        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background-color: #3a7bc8;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .btn-outline:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .editor-panel, .preview-panel {
                height: 50%;
            }
        }
        
        /* 模态窗口样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--sidebar-bg);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
        }
        
        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--sidebar-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>我的笔记</h2>
            <button class="btn" id="new-category-btn">新建分类</button>
        </div>
        <div class="sidebar-content">
            <ul class="category-tree" id="category-tree">
                <!-- 分类将通过JavaScript动态生成 -->
            </ul>
        </div>
    </div>
    
    <!-- 主内容区域 -->
    <div class="main-content">
        <div class="toolbar">
            <div>
                <button class="btn" id="new-note-btn">新建笔记</button>
                <button class="btn btn-outline" id="save-note-btn">保存笔记</button>
            </div>
            <div>
                <button class="btn btn-outline" id="toggle-preview-btn">切换预览</button>
            </div>
        </div>
        
        <input type="text" class="note-title" id="note-title" placeholder="笔记标题">
        
        <div class="editor-container">
            <div class="editor-panel">
                <textarea id="note-editor" placeholder="开始编写您的笔记...支持Markdown和LaTeX语法"></textarea>
            </div>
            <div class="preview-panel">
                <div class="preview" id="note-preview"></div>
            </div>
        </div>
    </div>
    
    <!-- 新建分类模态窗口 -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新建分类</h3>
                <span class="modal-close" id="close-category-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="category-name">分类名称</label>
                <input type="text" id="category-name" class="form-control">
            </div>
            <div class="form-group">
                <label for="parent-category">父级分类</label>
                <select id="parent-category" class="form-control">
                    <option value="">无（顶级分类）</option>
                </select>
            </div>
            <button class="btn" id="create-category-btn">创建</button>
        </div>
    </div>
    
    <script>
        // 笔记数据存储结构
        let notesData = {
            categories: [
                {
                    id: 1,
                    name: "工作笔记",
                    parentId: null,
                    children: [2, 3],
                    notes: [1]
                },
                {
                    id: 2,
                    name: "项目A",
                    parentId: 1,
                    children: [],
                    notes: [2]
                },
                {
                    id: 3,
                    name: "会议记录",
                    parentId: 1,
                    children: [],
                    notes: []
                },
                {
                    id: 4,
                    name: "学习笔记",
                    parentId: null,
                    children: [5],
                    notes: [3]
                },
                {
                    id: 5,
                    name: "数学",
                    parentId: 4,
                    children: [],
                    notes: [4]
                }
            ],
            notes: [
                {
                    id: 1,
                    title: "工作规划",
                    content: "# 2023年工作规划\n\n## 第一季度目标\n- 完成项目A的初步设计\n- 学习新技术X\n- 提高团队协作效率\n\n## 第二季度目标\n- 实施项目A的开发\n- 参加技术会议",
                    categoryId: 1,
                    lastModified: "2023-01-15"
                },
                {
                    id: 2,
                    title: "项目A需求分析",
                    content: "## 项目A需求分析\n\n### 功能需求\n1. 用户认证系统\n2. 数据可视化\n3. 报告生成\n\n### 技术栈\n- 前端: React + TypeScript\n- 后端: Node.js + Express\n- 数据库: MongoDB",
                    categoryId: 2,
                    lastModified: "2023-02-10"
                },
                {
                    id: 3,
                    title: "JavaScript学习笔记",
                    content: "# JavaScript核心概念\n\n## 闭包\n闭包是指有权访问另一个函数作用域中变量的函数。\n\n```javascript\nfunction outer() {\n    let count = 0;\n    return function inner() {\n        count++;\n        return count;\n    };\n}\n```",
                    categoryId: 4,
                    lastModified: "2023-01-20"
                },
                {
                    id: 4,
                    title: "微积分公式",
                    content: "# 微积分重要公式\n\n## 导数公式\n\n$$\\frac{d}{dx} x^n = nx^{n-1}$$\n\n$$\\frac{d}{dx} e^x = e^x$$\n\n$$\\frac{d}{dx} \\ln(x) = \\frac{1}{x}$$\n\n## 积分公式\n\n$$\\int x^n dx = \\frac{x^{n+1}}{n+1} + C$$\n\n$$\\int e^x dx = e^x + C$$",
                    categoryId: 5,
                    lastModified: "2023-02-05"
                }
            ],
            nextCategoryId: 6,
            nextNoteId: 5,
            currentNoteId: null,
            currentCategoryId: null
        };

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            // 从本地存储加载数据（如果存在）
            const savedData = localStorage.getItem('notesData');
            if (savedData) {
                notesData = JSON.parse(savedData);
            }
            
            // 渲染分类树
            renderCategoryTree();
            
            // 设置事件监听器
            setupEventListeners();
            
            // 默认显示第一个笔记
            if (notesData.notes.length > 0) {
                displayNote(notesData.notes[0].id);
            }
        });

        // 渲染分类树
        function renderCategoryTree() {
            const treeContainer = document.getElementById('category-tree');
            treeContainer.innerHTML = '';
            
            // 获取顶级分类
            const topLevelCategories = notesData.categories.filter(cat => cat.parentId === null);
            
            // 递归渲染分类
            topLevelCategories.forEach(category => {
                const categoryElement = createCategoryElement(category);
                treeContainer.appendChild(categoryElement);
            });
        }

        // 创建分类元素
        function createCategoryElement(category) {
            const li = document.createElement('li');
            li.className = 'category-item';
            if (category.id === notesData.currentCategoryId) {
                li.classList.add('active');
            }
            
            li.innerHTML = `
                <span class="icon">${category.children.length > 0 ? '📁' : '📄'}</span>
                <span class="category-name">${category.name}</span>
            `;
            
            li.dataset.categoryId = category.id;
            
            // 点击分类事件
            li.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // 切换展开/折叠
                if (category.children.length > 0) {
                    li.classList.toggle('expanded');
                }
                
                // 设置当前分类
                notesData.currentCategoryId = category.id;
                
                // 更新分类树高亮
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
                li.classList.add('active');
                
                // 显示该分类下的笔记列表（简化版，实际应用中可能需要弹出菜单）
                console.log(`切换到分类: ${category.name}`);
            });
            
            // 添加子分类
            if (category.children.length > 0) {
                const childrenUl = document.createElement('ul');
                childrenUl.className = 'category-children';
                
                category.children.forEach(childId => {
                    const childCategory = notesData.categories.find(cat => cat.id === childId);
                    if (childCategory) {
                        const childElement = createCategoryElement(childCategory);
                        childrenUl.appendChild(childElement);
                    }
                });
                
                li.appendChild(childrenUl);
            }
            
            return li;
        }

        // 显示笔记内容
        function displayNote(noteId) {
            const note = notesData.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesData.currentNoteId = noteId;
            notesData.currentCategoryId = note.categoryId;
            
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-editor').value = note.content;
            
            // 更新预览
            updatePreview();
            
            // 更新分类树高亮
            document.querySelectorAll('.category-item').forEach(item => {
                item.classList.remove('active');
                if (parseInt(item.dataset.categoryId) === note.categoryId) {
                    item.classList.add('active');
                }
            });
        }

        // 更新预览
        function updatePreview() {
            const editor = document.getElementById('note-editor');
            const preview = document.getElementById('note-preview');
            
            // 使用marked解析Markdown
            let htmlContent = marked.parse(editor.value);
            
            // 使用KaTeX渲染数学公式
            preview.innerHTML = htmlContent;
            
            // 渲染数学公式
            renderMathInElement(preview, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 编辑器内容变化时更新预览
            document.getElementById('note-editor').addEventListener('input', updatePreview);
            
            // 保存笔记
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            
            // 新建笔记
            document.getElementById('new-note-btn').addEventListener('click', createNewNote);
            
            // 切换预览模式
            document.getElementById('toggle-preview-btn').addEventListener('click', togglePreview);
            
            // 新建分类
            document.getElementById('new-category-btn').addEventListener('click', showCategoryModal);
            document.getElementById('close-category-modal').addEventListener('click', hideCategoryModal);
            document.getElementById('create-category-btn').addEventListener('click', createNewCategory);
            
            // 点击模态窗口外部关闭
            window.addEventListener('click', function(e) {
                const modal = document.getElementById('category-modal');
                if (e.target === modal) {
                    hideCategoryModal();
                }
            });
        }

        // 保存笔记
        function saveNote() {
            if (!notesData.currentNoteId) return;
            
            const noteIndex = notesData.notes.findIndex(n => n.id === notesData.currentNoteId);
            if (noteIndex === -1) return;
            
            notesData.notes[noteIndex].title = document.getElementById('note-title').value;
            notesData.notes[noteIndex].content = document.getElementById('note-editor').value;
            notesData.notes[noteIndex].lastModified = new Date().toISOString().split('T')[0];
            
            // 保存到本地存储
            localStorage.setItem('notesData', JSON.stringify(notesData));
            
            alert('笔记已保存！');
        }

        // 创建新笔记
        function createNewNote() {
            if (!notesData.currentCategoryId) {
                alert('请先选择一个分类！');
                return;
            }
            
            const newNote = {
                id: notesData.nextNoteId++,
                title: '新笔记',
                content: '# 新笔记\n\n开始编写您的内容...',
                categoryId: notesData.currentCategoryId,
                lastModified: new Date().toISOString().split('T')[0]
            };
            
            notesData.notes.push(newNote);
            notesData.currentNoteId = newNote.id;
            
            // 更新显示
            displayNote(newNote.id);
            
            // 保存到本地存储
            localStorage.setItem('notesData', JSON.stringify(notesData));
        }

        // 切换预览模式
        function togglePreview() {
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            
            if (editorPanel.style.display === 'none') {
                editorPanel.style.display = 'block';
                previewPanel.style.flex = '1';
            } else {
                editorPanel.style.display = 'none';
                previewPanel.style.flex = '2';
            }
        }

        // 显示分类模态窗口
        function showCategoryModal() {
            const modal = document.getElementById('category-modal');
            const parentSelect = document.getElementById('parent-category');
            
            // 清空并重新填充父级分类选项
            parentSelect.innerHTML = '<option value="">无（顶级分类）</option>';
            notesData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                parentSelect.appendChild(option);
            });
            
            modal.style.display = 'flex';
        }

        // 隐藏分类模态窗口
        function hideCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            document.getElementById('category-name').value = '';
        }

        // 创建新分类
        function createNewCategory() {
            const categoryName = document.getElementById('category-name').value.trim();
            const parentId = document.getElementById('parent-category').value;
            
            if (!categoryName) {
                alert('请输入分类名称！');
                return;
            }
            
            const newCategory = {
                id: notesData.nextCategoryId++,
                name: categoryName,
                parentId: parentId ? parseInt(parentId) : null,
                children: [],
                notes: []
            };
            
            notesData.categories.push(newCategory);
            
            // 如果选择了父级分类，更新父级的children数组
            if (parentId) {
                const parentCategory = notesData.categories.find(cat => cat.id === parseInt(parentId));
                if (parentCategory) {
                    parentCategory.children.push(newCategory.id);
                }
            }
            
            // 重新渲染分类树
            renderCategoryTree();
            
            // 隐藏模态窗口
            hideCategoryModal();
            
            // 保存到本地存储
            localStorage.setItem('notesData', JSON.stringify(notesData));
        }

        // KaTeX渲染函数
        function renderMathInElement(elem, options) {
            if (!elem) return;
            
            const tex = elem.textContent || elem.innerText;
            if (tex) {
                try {
                    elem.innerHTML = tex.replace(/\$\$(.*?)\$\$/g, (match, p1) => {
                        return katex.renderToString(p1, { displayMode: true });
                    }).replace(/\$(.*?)\$/g, (match, p1) => {
                        return katex.renderToString(p1, { displayMode: false });
                    });
                } catch (e) {
                    console.error('KaTeX渲染错误:', e);
                }
            }
        }
    </script>
</body>
</html>
