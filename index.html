<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>beRrYçš„ä¸ªäººç½‘é¡µ</title>
    <!-- Markdown è§£æå™¨ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX æ•°å­¦å…¬å¼æ”¯æŒ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --sidebar-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #4a90e2;
            --border-color: #404040;
            --hover-color: #3a3a3a;
            --danger-color: #e74c3c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        /* åˆ†ç±»æ ‘æ ·å¼ */
        .category-tree {
            list-style: none;
        }
        
        .category-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        
        .category-item:hover {
            background-color: var(--hover-color);
        }
        
        .category-item.active {
            background-color: var(--accent-color);
        }
        
        .category-item .icon {
            margin-right: 8px;
            font-size: 14px;
        }
        
        .category-item .actions {
            display: none;
        }
        
        .category-item:hover .actions {
            display: flex;
        }
        
        .category-children {
            margin-left: 20px;
            display: none;
        }
        
        .category-item.expanded > .category-children {
            display: block;
        }
        
        .notes-list {
            margin-top: 10px;
            margin-left: 20px;
            display: none;
        }
        
        .category-item.expanded > .notes-list {
            display: block;
        }
        
        .note-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.2s;
        }
        
        .note-item:hover {
            background-color: var(--hover-color);
        }
        
        .note-item.active {
            background-color: var(--accent-color);
        }
        
        .note-item .note-info {
            display: flex;
            flex-direction: column;
        }
        
        .note-item .note-title {
            font-weight: bold;
        }
        
        .note-item .note-date {
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .note-item .actions {
            display: none;
        }
        
        .note-item:hover .actions {
            display: flex;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .note-title {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: bold;
            width: 100%;
            padding: 5px 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .editor-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .editor-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }
        
        .preview-panel {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        textarea {
            width: 100%;
            flex: 1;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 15px;
            resize: none;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .preview {
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 4px;
            flex: 1;
            overflow-y: auto;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:hover {
            background-color: #3a7bc8;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .btn-outline:hover {
            background-color: rgba(74, 144, 226, 0.1);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
            }
            
            .editor-container {
                flex-direction: column;
            }
            
            .editor-panel, .preview-panel {
                height: 50%;
            }
        }
        
        /* æ¨¡æ€çª—å£æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: var(--sidebar-bg);
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-close {
            cursor: pointer;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--sidebar-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            color: #888;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        /* è¯­æ³•æç¤º */
        .syntax-help {
            background-color: var(--sidebar-bg);
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-size: 0.8rem;
            color: #aaa;
        }
        
        .syntax-help summary {
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .syntax-help table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .syntax-help td {
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-book"></i> æˆ‘çš„ç¬”è®°</h2>
            <button class="btn" id="new-category-btn"><i class="fas fa-folder-plus"></i> æ–°å»ºåˆ†ç±»</button>
        </div>
        <div class="sidebar-content">
            <ul class="category-tree" id="category-tree">
                <!-- åˆ†ç±»å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </ul>
        </div>
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
        <div class="toolbar">
            <div>
                <button class="btn" id="new-note-btn"><i class="fas fa-plus"></i> æ–°å»ºç¬”è®°</button>
                <button class="btn" id="save-note-btn"><i class="fas fa-save"></i> ä¿å­˜ç¬”è®°</button>
            </div>
            <div>
                <button class="btn btn-outline" id="toggle-preview-btn"><i class="fas fa-eye"></i> åˆ‡æ¢é¢„è§ˆ</button>
            </div>
        </div>
        
        <input type="text" class="note-title" id="note-title" placeholder="ç¬”è®°æ ‡é¢˜">
        
        <div class="editor-container">
            <div class="editor-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-edit"></i> ç¼–è¾‘å™¨</h3>
                    <span>Markdown + KaTeX</span>
                </div>
                <textarea id="note-editor" placeholder="å¼€å§‹ç¼–å†™æ‚¨çš„ç¬”è®°...æ”¯æŒMarkdownå’ŒLaTeXè¯­æ³•"></textarea>
                <div class="syntax-help">
                    <details>
                        <summary>è¯­æ³•æç¤º</summary>
                        <table>
                            <tr><td># æ ‡é¢˜</td><td>**ç²—ä½“**</td><td>*æ–œä½“*</td></tr>
                            <tr><td>- åˆ—è¡¨</td><td>[é“¾æ¥](URL)</td><td>`ä»£ç `</td></tr>
                            <tr><td>$$å…¬å¼$$</td><td>> å¼•ç”¨</td><td>--- åˆ†å‰²çº¿</td></tr>
                        </table>
                    </details>
                </div>
            </div>
            <div class="preview-panel">
                <div class="panel-header">
                    <h3><i class="fas fa-file-alt"></i> é¢„è§ˆ</h3>
                    <span id="last-modified">æœ€åç¼–è¾‘: --</span>
                </div>
                <div class="preview" id="note-preview">
                    <div class="empty-state">
                        <i class="fas fa-sticky-note"></i>
                        <p>é€‰æ‹©æˆ–åˆ›å»ºç¬”è®°å¼€å§‹ç¼–è¾‘</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ–°å»ºåˆ†ç±»æ¨¡æ€çª—å£ -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ–°å»ºåˆ†ç±»</h3>
                <span class="modal-close" id="close-category-modal">&times;</span>
            </div>
            <div class="form-group">
                <label for="category-name">åˆ†ç±»åç§°</label>
                <input type="text" id="category-name" class="form-control">
            </div>
            <div class="form-group">
                <label for="parent-category">çˆ¶çº§åˆ†ç±»</label>
                <select id="parent-category" class="form-control">
                    <option value="">æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰</option>
                </select>
            </div>
            <button class="btn" id="create-category-btn">åˆ›å»º</button>
        </div>
    </div>
    
    <!-- åˆ é™¤ç¡®è®¤æ¨¡æ€çª—å£ -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="delete-title">ç¡®è®¤åˆ é™¤</h3>
                <span class="modal-close" id="close-delete-modal">&times;</span>
            </div>
            <div class="form-group">
                <p id="delete-message">æ‚¨ç¡®å®šè¦åˆ é™¤æ­¤é¡¹å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" id="confirm-delete-btn">åˆ é™¤</button>
                <button class="btn btn-outline" id="cancel-delete-btn">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <script>
        // ç¬”è®°æ•°æ®å­˜å‚¨ç»“æ„
        let notesData = {
            categories: [
                {
                    id: 1,
                    name: "å·¥ä½œç¬”è®°",
                    parentId: null,
                    children: [2, 3],
                    notes: [1]
                },
                {
                    id: 2,
                    name: "é¡¹ç›®A",
                    parentId: 1,
                    children: [],
                    notes: [2]
                },
                {
                    id: 3,
                    name: "ä¼šè®®è®°å½•",
                    parentId: 1,
                    children: [],
                    notes: []
                },
                {
                    id: 4,
                    name: "å­¦ä¹ ç¬”è®°",
                    parentId: null,
                    children: [5],
                    notes: [3]
                },
                {
                    id: 5,
                    name: "æ•°å­¦",
                    parentId: 4,
                    children: [],
                    notes: [4]
                }
            ],
            notes: [
                {
                    id: 1,
                    title: "å·¥ä½œè§„åˆ’",
                    content: "# 2023å¹´å·¥ä½œè§„åˆ’\n\n## ç¬¬ä¸€å­£åº¦ç›®æ ‡\n- å®Œæˆé¡¹ç›®Açš„åˆæ­¥è®¾è®¡\n- å­¦ä¹ æ–°æŠ€æœ¯X\n- æé«˜å›¢é˜Ÿåä½œæ•ˆç‡\n\n## ç¬¬äºŒå­£åº¦ç›®æ ‡\n- å®æ–½é¡¹ç›®Açš„å¼€å‘\n- å‚åŠ æŠ€æœ¯ä¼šè®®",
                    categoryId: 1,
                    lastModified: "2023-01-15"
                },
                {
                    id: 2,
                    title: "é¡¹ç›®Aéœ€æ±‚åˆ†æ",
                    content: "## é¡¹ç›®Aéœ€æ±‚åˆ†æ\n\n### åŠŸèƒ½éœ€æ±‚\n1. ç”¨æˆ·è®¤è¯ç³»ç»Ÿ\n2. æ•°æ®å¯è§†åŒ–\n3. æŠ¥å‘Šç”Ÿæˆ\n\n### æŠ€æœ¯æ ˆ\n- å‰ç«¯: React + TypeScript\n- åç«¯: Node.js + Express\n- æ•°æ®åº“: MongoDB",
                    categoryId: 2,
                    lastModified: "2023-02-10"
                },
                {
                    id: 3,
                    title: "JavaScriptå­¦ä¹ ç¬”è®°",
                    content: "# JavaScriptæ ¸å¿ƒæ¦‚å¿µ\n\n## é—­åŒ…\né—­åŒ…æ˜¯æŒ‡æœ‰æƒè®¿é—®å¦ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸä¸­å˜é‡çš„å‡½æ•°ã€‚\n\n```javascript\nfunction outer() {\n    let count = 0;\n    return function inner() {\n        count++;\n        return count;\n    };\n}\n```",
                    categoryId: 4,
                    lastModified: "2023-01-20"
                },
                {
                    id: 4,
                    title: "å¾®ç§¯åˆ†å…¬å¼",
                    content: "# å¾®ç§¯åˆ†é‡è¦å…¬å¼\n\n## å¯¼æ•°å…¬å¼\n\n$$\\frac{d}{dx} x^n = nx^{n-1}$$\n\n$$\\frac{d}{dx} e^x = e^x$$\n\n$$\\frac{d}{dx} \\ln(x) = \\frac{1}{x}$$\n\n## ç§¯åˆ†å…¬å¼\n\n$$\\int x^n dx = \\frac{x^{n+1}}{n+1} + C$$\n\n$$\\int e^x dx = e^x + C$$",
                    categoryId: 5,
                    lastModified: "2023-02-05"
                }
            ],
            nextCategoryId: 6,
            nextNoteId: 5,
            currentNoteId: null,
            currentCategoryId: null
        };

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const savedData = localStorage.getItem('notesData');
            if (savedData) {
                notesData = JSON.parse(savedData);
            }
            
            // æ¸²æŸ“åˆ†ç±»æ ‘
            renderCategoryTree();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ªç¬”è®°
            if (notesData.notes.length > 0) {
                displayNote(notesData.notes[0].id);
            }
        });

        // æ¸²æŸ“åˆ†ç±»æ ‘
        function renderCategoryTree() {
            const treeContainer = document.getElementById('category-tree');
            treeContainer.innerHTML = '';
            
            // è·å–é¡¶çº§åˆ†ç±»
            const topLevelCategories = notesData.categories.filter(cat => cat.parentId === null);
            
            if (topLevelCategories.length === 0) {
                treeContainer.innerHTML = '<div class="empty-state"><i class="fas fa-folder-open"></i><p>æš‚æ— åˆ†ç±»ï¼Œç‚¹å‡»"æ–°å»ºåˆ†ç±»"å¼€å§‹</p></div>';
                return;
            }
            
            // é€’å½’æ¸²æŸ“åˆ†ç±»
            topLevelCategories.forEach(category => {
                const categoryElement = createCategoryElement(category);
                treeContainer.appendChild(categoryElement);
            });
        }

        // åˆ›å»ºåˆ†ç±»å…ƒç´ 
        function createCategoryElement(category) {
            const li = document.createElement('li');
            li.className = 'category-item';
            if (category.id === notesData.currentCategoryId) {
                li.classList.add('active');
            }
            
            li.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <span class="icon">${category.children.length > 0 ? 'ğŸ“' : 'ğŸ“„'}</span>
                    <span class="category-name">${category.name}</span>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-outline add-note-btn" title="æ·»åŠ ç¬”è®°"><i class="fas fa-plus"></i></button>
                    <button class="btn btn-sm btn-outline add-category-btn" title="æ·»åŠ å­åˆ†ç±»"><i class="fas fa-folder-plus"></i></button>
                    <button class="btn btn-sm btn-danger delete-category-btn" title="åˆ é™¤åˆ†ç±»"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            li.dataset.categoryId = category.id;
            
            // ç‚¹å‡»åˆ†ç±»äº‹ä»¶
            li.querySelector('.category-name').addEventListener('click', function(e) {
                e.stopPropagation();
                
                // åˆ‡æ¢å±•å¼€/æŠ˜å 
                if (category.children.length > 0 || category.notes.length > 0) {
                    li.classList.toggle('expanded');
                }
                
                // è®¾ç½®å½“å‰åˆ†ç±»
                notesData.currentCategoryId = category.id;
                
                // æ›´æ–°åˆ†ç±»æ ‘é«˜äº®
                document.querySelectorAll('.category-item').forEach(item => {
                    item.classList.remove('active');
                });
                li.classList.add('active');
                
                // å¦‚æœæœ‰ç¬”è®°ï¼Œæ˜¾ç¤ºç¬¬ä¸€ä¸ª
                if (category.notes.length > 0) {
                    displayNote(category.notes[0]);
                } else {
                    // æ¸…ç©ºç¼–è¾‘å™¨
                    clearEditor();
                }
            });
            
            // æ·»åŠ ç¬”è®°æŒ‰é’®
            li.querySelector('.add-note-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                createNewNote(category.id);
            });
            
            // æ·»åŠ å­åˆ†ç±»æŒ‰é’®
            li.querySelector('.add-category-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                showCategoryModal(category.id);
            });
            
            // åˆ é™¤åˆ†ç±»æŒ‰é’®
            li.querySelector('.delete-category-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                showDeleteModal('category', category.id, category.name);
            });
            
            // æ·»åŠ å­åˆ†ç±»
            if (category.children.length > 0) {
                const childrenUl = document.createElement('ul');
                childrenUl.className = 'category-children';
                
                category.children.forEach(childId => {
                    const childCategory = notesData.categories.find(cat => cat.id === childId);
                    if (childCategory) {
                        const childElement = createCategoryElement(childCategory);
                        childrenUl.appendChild(childElement);
                    }
                });
                
                li.appendChild(childrenUl);
            }
            
            // æ·»åŠ ç¬”è®°åˆ—è¡¨
            if (category.notes.length > 0) {
                const notesUl = document.createElement('ul');
                notesUl.className = 'notes-list';
                
                category.notes.forEach(noteId => {
                    const note = notesData.notes.find(n => n.id === noteId);
                    if (note) {
                        const noteElement = createNoteElement(note);
                        notesUl.appendChild(noteElement);
                    }
                });
                
                li.appendChild(notesUl);
            }
            
            return li;
        }

        // åˆ›å»ºç¬”è®°å…ƒç´ 
        function createNoteElement(note) {
            const li = document.createElement('li');
            li.className = 'note-item';
            if (note.id === notesData.currentNoteId) {
                li.classList.add('active');
            }
            
            li.innerHTML = `
                <div class="note-info">
                    <div class="note-title">${note.title}</div>
                    <div class="note-date">${note.lastModified}</div>
                </div>
                <div class="actions">
                    <button class="btn btn-sm btn-danger delete-note-btn" title="åˆ é™¤ç¬”è®°"><i class="fas fa-trash"></i></button>
                </div>
            `;
            
            li.dataset.noteId = note.id;
            
            // ç‚¹å‡»ç¬”è®°äº‹ä»¶
            li.addEventListener('click', function(e) {
                e.stopPropagation();
                displayNote(note.id);
            });
            
            // åˆ é™¤ç¬”è®°æŒ‰é’®
            li.querySelector('.delete-note-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                showDeleteModal('note', note.id, note.title);
            });
            
            return li;
        }

        // æ˜¾ç¤ºç¬”è®°å†…å®¹
        function displayNote(noteId) {
            const note = notesData.notes.find(n => n.id === noteId);
            if (!note) return;
            
            notesData.currentNoteId = noteId;
            notesData.currentCategoryId = note.categoryId;
            
            document.getElementById('note-title').value = note.title;
            document.getElementById('note-editor').value = note.content;
            document.getElementById('last-modified').textContent = `æœ€åç¼–è¾‘: ${note.lastModified}`;
            
            // æ›´æ–°é¢„è§ˆ
            updatePreview();
            
            // æ›´æ–°åˆ†ç±»æ ‘é«˜äº®
            document.querySelectorAll('.category-item, .note-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // é«˜äº®å½“å‰åˆ†ç±»
            const categoryItem = document.querySelector(`.category-item[data-category-id="${note.categoryId}"]`);
            if (categoryItem) {
                categoryItem.classList.add('active');
            }
            
            // é«˜äº®å½“å‰ç¬”è®°
            const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
            if (noteItem) {
                noteItem.classList.add('active');
            }
        }

        // æ¸…ç©ºç¼–è¾‘å™¨
        function clearEditor() {
            document.getElementById('note-title').value = '';
            document.getElementById('note-editor').value = '';
            document.getElementById('last-modified').textContent = 'æœ€åç¼–è¾‘: --';
            document.getElementById('note-preview').innerHTML = '<div class="empty-state"><i class="fas fa-sticky-note"></i><p>é€‰æ‹©æˆ–åˆ›å»ºç¬”è®°å¼€å§‹ç¼–è¾‘</p></div>';
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            const editor = document.getElementById('note-editor');
            const preview = document.getElementById('note-preview');
            
            if (editor.value.trim() === '') {
                preview.innerHTML = '<div class="empty-state"><i class="fas fa-sticky-note"></i><p>å¼€å§‹ç¼–å†™ç¬”è®°ï¼Œé¢„è§ˆå°†åœ¨æ­¤å¤„æ˜¾ç¤º</p></div>';
                return;
            }
            
            // ä½¿ç”¨markedè§£æMarkdown
            let htmlContent = marked.parse(editor.value);
            
            // ä½¿ç”¨KaTeXæ¸²æŸ“æ•°å­¦å…¬å¼
            preview.innerHTML = htmlContent;
            
            // æ¸²æŸ“æ•°å­¦å…¬å¼
            renderMathInElement(preview, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // ç¼–è¾‘å™¨å†…å®¹å˜åŒ–æ—¶æ›´æ–°é¢„è§ˆ
            document.getElementById('note-editor').addEventListener('input', updatePreview);
            
            // ç¬”è®°æ ‡é¢˜å˜åŒ–æ—¶æ›´æ–°ä¾§è¾¹æ 
            document.getElementById('note-title').addEventListener('input', function() {
                if (notesData.currentNoteId) {
                    const noteIndex = notesData.notes.findIndex(n => n.id === notesData.currentNoteId);
                    if (noteIndex !== -1) {
                        notesData.notes[noteIndex].title = this.value;
                        notesData.notes[noteIndex].lastModified = new Date().toISOString().split('T')[0];
                        
                        // æ›´æ–°ä¾§è¾¹æ 
                        renderCategoryTree();
                        
                        // é‡æ–°é«˜äº®å½“å‰ç¬”è®°
                        const noteItem = document.querySelector(`.note-item[data-note-id="${notesData.currentNoteId}"]`);
                        if (noteItem) {
                            noteItem.classList.add('active');
                        }
                    }
                }
            });
            
            // ä¿å­˜ç¬”è®°
            document.getElementById('save-note-btn').addEventListener('click', saveNote);
            
            // æ–°å»ºç¬”è®°
            document.getElementById('new-note-btn').addEventListener('click', function() {
                if (!notesData.currentCategoryId) {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ†ç±»ï¼');
                    return;
                }
                createNewNote(notesData.currentCategoryId);
            });
            
            // åˆ‡æ¢é¢„è§ˆæ¨¡å¼
            document.getElementById('toggle-preview-btn').addEventListener('click', togglePreview);
            
            // æ–°å»ºåˆ†ç±»
            document.getElementById('new-category-btn').addEventListener('click', showCategoryModal);
            document.getElementById('close-category-modal').addEventListener('click', hideCategoryModal);
            document.getElementById('create-category-btn').addEventListener('click', createNewCategory);
            
            // åˆ é™¤ç¡®è®¤
            document.getElementById('close-delete-modal').addEventListener('click', hideDeleteModal);
            document.getElementById('cancel-delete-btn').addEventListener('click', hideDeleteModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', confirmDelete);
            
            // ç‚¹å‡»æ¨¡æ€çª—å£å¤–éƒ¨å…³é—­
            window.addEventListener('click', function(e) {
                const categoryModal = document.getElementById('category-modal');
                const deleteModal = document.getElementById('delete-modal');
                
                if (e.target === categoryModal) {
                    hideCategoryModal();
                }
                if (e.target === deleteModal) {
                    hideDeleteModal();
                }
            });
        }

        // ä¿å­˜ç¬”è®°
        function saveNote() {
            if (!notesData.currentNoteId) return;
            
            const noteIndex = notesData.notes.findIndex(n => n.id === notesData.currentNoteId);
            if (noteIndex === -1) return;
            
            notesData.notes[noteIndex].title = document.getElementById('note-title').value;
            notesData.notes[noteIndex].content = document.getElementById('note-editor').value;
            notesData.notes[noteIndex].lastModified = new Date().toISOString().split('T')[0];
            
            // æ›´æ–°ä¾§è¾¹æ 
            renderCategoryTree();
            
            // é‡æ–°é«˜äº®å½“å‰ç¬”è®°
            const noteItem = document.querySelector(`.note-item[data-note-id="${notesData.currentNoteId}"]`);
            if (noteItem) {
                noteItem.classList.add('active');
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('notesData', JSON.stringify(notesData));
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            const saveBtn = document.getElementById('save-note-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check"></i> å·²ä¿å­˜';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
            }, 2000);
        }

        // åˆ›å»ºæ–°ç¬”è®°
        function createNewNote(categoryId) {
            const newNote = {
                id: notesData.nextNoteId++,
                title: 'æ–°ç¬”è®°',
                content: '# æ–°ç¬”è®°\n\nå¼€å§‹ç¼–å†™æ‚¨çš„å†…å®¹...',
                categoryId: categoryId,
                lastModified: new Date().toISOString().split('T')[0]
            };
            
            notesData.notes.push(newNote);
            
            // æ·»åŠ åˆ°åˆ†ç±»
            const categoryIndex = notesData.categories.findIndex(cat => cat.id === categoryId);
            if (categoryIndex !== -1) {
                notesData.categories[categoryIndex].notes.push(newNote.id);
            }
            
            // æ›´æ–°ä¾§è¾¹æ 
            renderCategoryTree();
            
            // æ˜¾ç¤ºæ–°ç¬”è®°
            displayNote(newNote.id);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('notesData', JSON.stringify(notesData));
        }

        // åˆ‡æ¢é¢„è§ˆæ¨¡å¼
        function togglePreview() {
            const editorPanel = document.querySelector('.editor-panel');
            const previewPanel = document.querySelector('.preview-panel');
            const toggleBtn = document.getElementById('toggle-preview-btn');
            
            if (editorPanel.style.display === 'none') {
                editorPanel.style.display = 'flex';
                previewPanel.style.flex = '1';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> åˆ‡æ¢é¢„è§ˆ';
            } else {
                editorPanel.style.display = 'none';
                previewPanel.style.flex = '2';
                toggleBtn.innerHTML = '<i class="fas fa-edit"></i> åˆ‡æ¢ç¼–è¾‘';
            }
        }

        // æ˜¾ç¤ºåˆ†ç±»æ¨¡æ€çª—å£
        function showCategoryModal(parentId = null) {
            const modal = document.getElementById('category-modal');
            const parentSelect = document.getElementById('parent-category');
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……çˆ¶çº§åˆ†ç±»é€‰é¡¹
            parentSelect.innerHTML = '<option value="">æ— ï¼ˆé¡¶çº§åˆ†ç±»ï¼‰</option>';
            notesData.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                if (parentId && category.id === parentId) {
                    option.selected = true;
                }
                parentSelect.appendChild(option);
            });
            
            modal.style.display = 'flex';
        }

        // éšè—åˆ†ç±»æ¨¡æ€çª—å£
        function hideCategoryModal() {
            document.getElementById('category-modal').style.display = 'none';
            document.getElementById('category-name').value = '';
        }

        // åˆ›å»ºæ–°åˆ†ç±»
        function createNewCategory() {
            const categoryName = document.getElementById('category-name').value.trim();
            const parentId = document.getElementById('parent-category').value;
            
            if (!categoryName) {
                alert('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼');
                return;
            }
            
            const newCategory = {
                id: notesData.nextCategoryId++,
                name: categoryName,
                parentId: parentId ? parseInt(parentId) : null,
                children: [],
                notes: []
            };
            
            notesData.categories.push(newCategory);
            
            // å¦‚æœé€‰æ‹©äº†çˆ¶çº§åˆ†ç±»ï¼Œæ›´æ–°çˆ¶çº§çš„childrenæ•°ç»„
            if (parentId) {
                const parentCategory = notesData.categories.find(cat => cat.id === parseInt(parentId));
                if (parentCategory) {
                    parentCategory.children.push(newCategory.id);
                }
            }
            
            // é‡æ–°æ¸²æŸ“åˆ†ç±»æ ‘
            renderCategoryTree();
            
            // éšè—æ¨¡æ€çª—å£
            hideCategoryModal();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('notesData', JSON.stringify(notesData));
        }

        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€çª—å£
        function showDeleteModal(type, id, name) {
            const modal = document.getElementById('delete-modal');
            const title = document.getElementById('delete-title');
            const message = document.getElementById('delete-message');
            
            if (type === 'category') {
                title.textContent = 'åˆ é™¤åˆ†ç±»';
                message.textContent = `æ‚¨ç¡®å®šè¦åˆ é™¤åˆ†ç±» "${name}" å—ï¼Ÿæ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰ç¬”è®°å’Œå­åˆ†ç±»ï¼Œä¸”ä¸å¯æ’¤é”€ã€‚`;
            } else {
                title.textContent = 'åˆ é™¤ç¬”è®°';
                message.textContent = `æ‚¨ç¡®å®šè¦åˆ é™¤ç¬”è®° "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`;
            }
            
            modal.dataset.deleteType = type;
            modal.dataset.deleteId = id;
            modal.style.display = 'flex';
        }

        // éšè—åˆ é™¤ç¡®è®¤æ¨¡æ€çª—å£
        function hideDeleteModal() {
            document.getElementById('delete-modal').style.display = 'none';
        }

        // ç¡®è®¤åˆ é™¤
        function confirmDelete() {
            const modal = document.getElementById('delete-modal');
            const type = modal.dataset.deleteType;
            const id = parseInt(modal.dataset.deleteId);
            
            if (type === 'category') {
                deleteCategory(id);
            } else {
                deleteNote(id);
            }
            
            hideDeleteModal();
        }

        // åˆ é™¤åˆ†ç±»
        function deleteCategory(categoryId) {
            // é€’å½’åˆ é™¤æ‰€æœ‰å­åˆ†ç±»å’Œç¬”è®°
            const deleteCategoryRecursive = (catId) => {
                const category = notesData.categories.find(cat => cat.id === catId);
                if (!category) return;
                
                // åˆ é™¤æ‰€æœ‰ç¬”è®°
                category.notes.forEach(noteId => {
                    deleteNote(noteId, false); // ä¸æ›´æ–°UIï¼Œæœ€åç»Ÿä¸€æ›´æ–°
                });
                
                // é€’å½’åˆ é™¤å­åˆ†ç±»
                category.children.forEach(childId => {
                    deleteCategoryRecursive(childId);
                });
                
                // ä»çˆ¶åˆ†ç±»ä¸­ç§»é™¤
                if (category.parentId) {
                    const parentCategory = notesData.categories.find(cat => cat.id === category.parentId);
                    if (parentCategory) {
                        parentCategory.children = parentCategory.children.filter(id => id !== catId);
                    }
                }
                
                // åˆ é™¤åˆ†ç±»æœ¬èº«
                notesData.categories = notesData.categories.filter(cat => cat.id !== catId);
            };
            
            deleteCategoryRecursive(categoryId);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰åˆ†ç±»ï¼Œæ¸…ç©ºç¼–è¾‘å™¨
            if (notesData.currentCategoryId === categoryId) {
                notesData.currentCategoryId = null;
                notesData.currentNoteId = null;
                clearEditor();
            }
            
            // æ›´æ–°ä¾§è¾¹æ 
            renderCategoryTree();
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('notesData', JSON.stringify(notesData));
        }

        // åˆ é™¤ç¬”è®°
        function deleteNote(noteId, updateUI = true) {
            const noteIndex = notesData.notes.findIndex(n => n.id === noteId);
            if (noteIndex === -1) return;
            
            const note = notesData.notes[noteIndex];
            
            // ä»åˆ†ç±»ä¸­ç§»é™¤
            const category = notesData.categories.find(cat => cat.id === note.categoryId);
            if (category) {
                category.notes = category.notes.filter(id => id !== noteId);
            }
            
            // åˆ é™¤ç¬”è®°
            notesData.notes.splice(noteIndex, 1);
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ç¬”è®°ï¼Œæ¸…ç©ºç¼–è¾‘å™¨
            if (notesData.currentNoteId === noteId) {
                notesData.currentNoteId = null;
                clearEditor();
            }
            
            if (updateUI) {
                // æ›´æ–°ä¾§è¾¹æ 
                renderCategoryTree();
                
                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('notesData', JSON.stringify(notesData));
            }
        }

        // KaTeXæ¸²æŸ“å‡½æ•°
        function renderMathInElement(elem, options) {
            if (!elem) return;
            
            // æŸ¥æ‰¾æ‰€æœ‰æ•°å­¦å…¬å¼
            const displayMath = elem.querySelectorAll('script[type="math/tex; mode=display"]');
            const inlineMath = elem.querySelectorAll('script[type="math/tex"]');
            
            // æ¸²æŸ“å—çº§å…¬å¼
            displayMath.forEach(math => {
                try {
                    katex.render(math.textContent, math, { displayMode: true });
                } catch (e) {
                    console.error('KaTeXæ¸²æŸ“é”™è¯¯:', e);
                }
            });
            
            // æ¸²æŸ“è¡Œå†…å…¬å¼
            inlineMath.forEach(math => {
                try {
                    katex.render(math.textContent, math, { displayMode: false });
                } catch (e) {
                    console.error('KaTeXæ¸²æŸ“é”™è¯¯:', e);
                }
            });
        }
    </script>
</body>
</html>
